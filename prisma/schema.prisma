// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum EventStatus {
  draft
  open
  closed
}

enum Budget {
  ONE   // $
  TWO   // $$
}

enum Diet {
  none
  vegetarian
  vegan
  pescatarian
  glutenFree
  dairyFree
}

enum Vibe {
  relaxed
  conversational
  mix
}

enum AfterDinner {
  home
  open
}

enum DinnerRequestStatus {
  OPEN
  MATCHED
  CANCELED
  EXPIRED
}

enum ProposedDinnerStatus {
  PENDING
  CONFIRMED
  CANCELED
}

model Event {
  id              String          @id @default(cuid())
  title           String
  city            String
  startAt         DateTime
  rsvpCloseAt     DateTime
  groupSize       Int             @default(6)
  status          EventStatus     @default(draft)
  createdAt       DateTime        @default(now())

  rsvps           Rsvp[]
  proposedDinner  ProposedDinner?

  @@index([status, rsvpCloseAt])
}

model Rsvp {
  id            String       @id @default(cuid())
  eventId       String
  event         Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Contact Info (Step B)
  name          String
  email         String
  phone         String

  // Preferences (Step A)
  partySize     Int          // 1 or 2
  budget        Budget
  diet          Diet
  allergies     String       @default("")
  vibe          Vibe?
  afterDinner   AfterDinner?

  createdAt     DateTime     @default(now())

  @@unique([eventId, email], name: "unique_event_email")
  @@index([eventId])
  @@index([email])
}

model DinnerRequest {
  id                    String                @id @default(cuid())
  createdAt             DateTime              @default(now())
  status                DinnerRequestStatus   @default(OPEN)

  // Location
  city                  String

  // Primary contact (required)
  name                  String
  phone                 String                // E.164 format, unique identifier
  email                 String?               // Optional

  // Couple handling
  isCouple              Boolean               @default(false)
  partnerName           String?
  partnerPhone          String?

  // Preferences
  budget                Budget
  diet                  Diet
  allergies             String                @default("")
  vibe                  Vibe?

  // Availability (JSON for now)
  availabilityWindows   Json?

  // Relations
  proposedDinnerMembers ProposedDinnerMember[]

  @@index([phone, status])
  @@index([city, status])
}

model ProposedDinner {
  id          String                @id @default(cuid())
  createdAt   DateTime              @default(now())
  status      ProposedDinnerStatus  @default(PENDING)

  // Event details
  eventId     String?               @unique
  event       Event?                @relation(fields: [eventId], references: [id])

  city        String
  scheduledAt DateTime?

  // Relations
  members     ProposedDinnerMember[]

  @@index([status, city])
}

model ProposedDinnerMember {
  id                String         @id @default(cuid())
  createdAt         DateTime       @default(now())

  proposedDinnerId  String
  proposedDinner    ProposedDinner @relation(fields: [proposedDinnerId], references: [id], onDelete: Cascade)

  dinnerRequestId   String
  dinnerRequest     DinnerRequest  @relation(fields: [dinnerRequestId], references: [id])

  // Contact info (denormalized for convenience)
  phone             String
  partnerPhone      String?
  partySize         Int

  // Confirmation
  confirmed         Boolean        @default(false)
  confirmedAt       DateTime?

  @@index([proposedDinnerId])
  @@index([dinnerRequestId])
  @@index([phone])
}
