// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum EventStatus {
  draft
  open
  closed
}

enum Budget {
  ONE   // $
  TWO   // $$
}

enum Diet {
  none
  vegetarian
  vegan
  pescatarian
  glutenFree
  dairyFree
}

enum Vibe {
  relaxed
  conversational
  mix
}

enum AfterDinner {
  home
  open
}

enum HomeRegion {
  NORTH_BAY
  SAN_FRANCISCO
  EAST_BAY
  SOUTH_BAY
}

enum TravelRadius {
  LOCAL
  SHORT_DRIVE
  LONG_DRIVE
}

enum AgeRange {
  UNDER_25
  AGE_25_34
  AGE_35_44
  AGE_45_54
  AGE_55_PLUS
  NO_ANSWER
}

enum DinnerFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  RARELY
  NO_ANSWER
}

enum ReferralSource {
  FRIEND
  INSTAGRAM
  TIKTOK
  GOOGLE
  REDDIT
  WALKING_BY
  NEWS
  OTHER
  NO_ANSWER
}

// Sprint 2: MVP Matching Enums
enum Region {
  NORTH_BAY
  SAN_FRANCISCO
  EAST_BAY
  SOUTH_BAY
}

enum TimeWindow {
  THIS_WEEK
  NEXT_WEEK
  FLEXIBLE
}

enum PartyType {
  SOLO
  COUPLE
}

enum MatchPreference {
  SOLO_ONLY
  COUPLE_ONLY
  OPEN
}

enum MatchRequestStatus {
  OPEN
  MATCHED_PENDING_CONFIRMATION
  CONFIRMED
  CANCELED
  EXPIRED
}

enum DinnerMatchStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  CANCELED
  EXPIRED
}

enum DinnerRequestStatus {
  OPEN
  MATCHED
  CANCELED
  EXPIRED
}

enum ProposedDinnerStatus {
  PENDING
  CONFIRMED
  CANCELED
}

model Event {
  id              String          @id @default(cuid())
  title           String
  city            String
  startAt         DateTime
  rsvpCloseAt     DateTime
  groupSize       Int             @default(6)
  status          EventStatus     @default(draft)
  createdAt       DateTime        @default(now())

  rsvps           Rsvp[]
  proposedDinner  ProposedDinner?

  @@index([status, rsvpCloseAt])
}

model Rsvp {
  id            String       @id @default(cuid())
  eventId       String
  event         Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Contact Info (Step B)
  name          String
  email         String
  phone         String

  // Preferences (Step A)
  partySize     Int          // 1 or 2
  budget        Budget
  diet          Diet
  allergies     String       @default("")
  vibe          Vibe?
  afterDinner   AfterDinner?

  createdAt     DateTime     @default(now())

  @@unique([eventId, email], name: "unique_event_email")
  @@index([eventId])
  @@index([email])
}

model DinnerRequest {
  id                    String                @id @default(cuid())
  createdAt             DateTime              @default(now())
  status                DinnerRequestStatus   @default(OPEN)

  // Location
  city                  String

  // Primary contact (required)
  name                  String
  phone                 String                // E.164 format, unique identifier
  email                 String?               // Optional

  // Couple handling
  isCouple              Boolean               @default(false)
  partnerName           String?
  partnerPhone          String?

  // Preferences
  budget                Budget
  diet                  Diet
  allergies             String                @default("")
  vibe                  Vibe?

  // Availability (JSON for now)
  availabilityWindows   Json?

  // Relations
  proposedDinnerMembers ProposedDinnerMember[]

  @@index([phone, status])
  @@index([city, status])
}

model ProposedDinner {
  id          String                @id @default(cuid())
  createdAt   DateTime              @default(now())
  status      ProposedDinnerStatus  @default(PENDING)

  // Event details
  eventId     String?               @unique
  event       Event?                @relation(fields: [eventId], references: [id])

  city        String
  scheduledAt DateTime?

  // Relations
  members     ProposedDinnerMember[]

  @@index([status, city])
}

model ProposedDinnerMember {
  id                String         @id @default(cuid())
  createdAt         DateTime       @default(now())

  proposedDinnerId  String
  proposedDinner    ProposedDinner @relation(fields: [proposedDinnerId], references: [id], onDelete: Cascade)

  dinnerRequestId   String
  dinnerRequest     DinnerRequest  @relation(fields: [dinnerRequestId], references: [id])

  // Contact info (denormalized for convenience)
  phone             String
  partnerPhone      String?
  partySize         Int

  // Confirmation
  confirmed         Boolean        @default(false)
  confirmedAt       DateTime?

  @@index([proposedDinnerId])
  @@index([dinnerRequestId])
  @@index([phone])
}

model Member {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Identity
  phone     String   @unique // E.164 format
  fullName  String?

  // Profile
  homeRegion        HomeRegion?
  travelRadius      TravelRadius?
  ageRange          AgeRange?
  dinnerFrequency   DinnerFrequency?
  diningStyle       String[]        @default([]) // multi-select tags
  socialPreference  String?         // couples, solo, mixed, any
  referralSource    ReferralSource?

  // Status
  status              String    @default("waitlist") // waitlist, active, inactive
  onboardingCompletedAt DateTime?

  // Notification tracking
  notifiedAt DateTime?

  // Relations
  matchRequests MatchRequest[]

  @@index([phone])
  @@index([status])
}

model PhoneVerificationCode {
  id         String    @id @default(cuid())
  phone      String
  codeHash   String
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  attempts   Int       @default(0)
  verifiedAt DateTime?
  lastResendAt DateTime?

  @@index([phone])
  @@index([expiresAt])
}

// Sprint 2: MVP Matching Models
model MatchRequest {
  id               String              @id @default(cuid())
  createdAt        DateTime            @default(now())

  memberId         String
  member           Member              @relation(fields: [memberId], references: [id])

  region           Region
  timeWindow       TimeWindow
  partyType        PartyType
  matchPreference  MatchPreference
  status           MatchRequestStatus  @default(OPEN)

  matchId          String?
  matchAsA         DinnerMatch?        @relation("MatchA")
  matchAsB         DinnerMatch?        @relation("MatchB")

  @@index([status, region, createdAt])
  @@index([memberId])
}

model DinnerMatch {
  id               String             @id @default(cuid())
  createdAt        DateTime           @default(now())
  status           DinnerMatchStatus  @default(PENDING_CONFIRMATION)

  requestAId       String             @unique
  requestA         MatchRequest       @relation("MatchA", fields: [requestAId], references: [id])

  requestBId       String             @unique
  requestB         MatchRequest       @relation("MatchB", fields: [requestBId], references: [id])

  phoneA           String
  phoneB           String

  confirmAAt       DateTime?
  confirmBAt       DateTime?
  canceledReason   String?

  @@index([status])
  @@index([phoneA])
  @@index([phoneB])
}
